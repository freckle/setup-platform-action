# Setup Platform Action

GitHub Action to install and configure our [PlatformCLI][platform] and
[Stackctl][] tools.

[platform]: https://github.com/freckle/platform
[stackctl]: https://github.com/freckle/stackctl

**NOTE**: This action is public so that we can use it outside of its own
repository, but the tooling it installs and uses is private. It is of no use
outside Freckle.

## Usage

```yaml
- id: setup
  uses: freckle/setup-platform-action@v7
  with:
    # Required
    token: ${{ secrets.X }}

    # Optional
    # version: 2.4.1.0
    # environment: prod
    # app: my-app               # If in multi-app repository
    # resource: my-resource     # If in multi-resource app
    # stackctl-version: 1.2.0.0
```

The action installs a `platform` executable, configures `PLATFORM_*` environment
variables (so you can just invoke it without global options throughout the
remainder of your workflow), and sets the `tag` output.

This can be used to build and push images,

```yaml
# Naive docker-build for the purposes of example only. You should probably use
# more advanced docker-actions, i.e. to include caching.
- run: |
    read -r repo < <(platform query settings.EcrRepository)
    app_image="$repo:${{ steps.setup.outputs.tag }}"
    docker build --tag "$app_image" .

- run: platform container:login
- run: platform container:push --tag '${{ steps.setup.outputs.tag }}'
```

Build and push assets,

```yaml
- run: platform assets:push
```

Or deploy

```yaml
- run: platform deploy --tag '${{ steps.setup.outputs.tag }}'
```

## Stackctl

The action also installs a `stackctl` executable and configures `STACKCTL_*`
variables to work with the specifications generated by PlatformCLI. This means
you can do things like post changeset details to our PR if you've edited the
app's `.platform.yaml`:

```yaml
- if: ${{ changes.platform-yaml == 'true' }}
  run: |
    # Generates content in .platform/specs
    platform deploy --tag '${{ steps.prep.outputs.tag }}' --inspect

    # Work with it naturally using Stackctl
    stackctl changes --format pr /tmp/changes.md

- if: ${{ changes.platform-yaml == 'true' }}
  uses: freckle/add-pr-comment@v1
  with:
    message-path: /tmp/changes.md
```

## Inputs

- **version**: the version of PlatformCLI to install. Do not include the `v`
  prefix here. The default will change over time, and is meant to be kept up
  with latest as best we can.

- **token**: a GitHub access token with rights to fetch the private PlatformCLI
  release artifacts.

- **environment**: if present, this will be set as `PLATFORM_ENVIRONMENT` for
  the remainder of the workflow. For details on what this affects, see
  `platform(1)`.

- **app**: if present, this will be set as `PLATFORM_APP` for the remainder of
  the workflow. For details on what this affects, see `platform(1)`.

- **resource**: if present, this will be set as `PLATFORM_RESOURCE` for the
  remainder of the workflow. For details on what this affects, see
  `platform(1)`.

- **no-validate**: if present, this will be set as `PLATFORM_NO_VALIDATE` for
  the remainder of the workflow. For details on what this affects, see
  `platform(1)`.

- **stackctl-version**: the version of Stackctl to install. Do not include the
  `v` prefix here. The default will change over time, and is meant to be kept up
  with latest as best we can.

## Outputs

- **tag**: a consistent, source-specific value that should be used throughout
  build/push/deploy actions. It's currently the head sha for PR events, or
  `github.sha` otherwise.

---

[LICENSE](./LICENSE)
